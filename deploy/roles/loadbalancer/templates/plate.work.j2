# Set up load balancing
upstream plateapp {
    # prod-01.plate.work
    server 10.136.11.166;
    # prod-02.plate.work
    # server 10.136.12.54;
}
upstream plateapp-testing {
    # prod-01.plate.work
    # server 10.136.11.166;
    # prod-02.plate.work
    server 10.136.12.54;
}
upstream plateapp-staging {
    # staging-01.plate.work
    server 192.241.141.148;
}
server {
    listen 192.241.156.89:80;
    server_name plate.work;
    # Redirect all http requests to https
    return 301 https://www.plate.work$request_uri;
}
server {
    listen 192.241.156.89:443 ssl;
    server_name plate.work;

    return 301 https://www.plate.work$request_uri;

    ssl on;
    ssl_certificate         /opt/secret/plate/ssl/plate-bundle.crt;
    ssl_certificate_key     /opt/secret/plate/ssl/www.plate.work.key;

    # Harden SSL
    ssl_prefer_server_ciphers      on;
    ssl_protocols                  SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers                    ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;

    add_header Strict-Transport-Security "max-age=31536000";
}
server {
    listen 192.241.156.89:443 ssl;
    server_name www.plate.work;

    ssl on;
    ssl_certificate         /opt/secret/plate/ssl/plate-bundle.crt;
    ssl_certificate_key     /opt/secret/plate/ssl/www.plate.work.key;

    # Harden SSL
    ssl_prefer_server_ciphers      on;
    ssl_protocols                  SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers                    ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;

    add_header Strict-Transport-Security "max-age=31536000";

    # Proxy setup
    location / {
        proxy_pass http://plateapp;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /testing/ {
       	include includes/testing-ips;
       	deny all;

        proxy_pass http://plateapp-testing/;
        #proxy_set_header Host $host;
        #proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #proxy_set_header X-Forwarded-Proto $scheme;
    }
    # rest of directives
}